<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Trading Market</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }
    
    body, html {
      height: 100%;
      color: #0c0b0b;
      overflow-x: hidden;
      position: relative;
    }
    
    .background-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    
    .background-container video {
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      object-fit: cover;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(12, 12, 12, 0.85);
      padding: 10px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1;
    }
    
    .logo-title {
      display: flex;
      align-items: center;
    }
    
    .logo-title video {
      width: 50px;
      height: 50px;
      margin-right: 15px;
    }
    
    .logo-title h1 {
      font-size: 28px;
      font-weight: bold;
      color: #2e7d32;
      cursor: pointer;
    }
    
    .nav {
      display: flex;
      gap: 15px;
    }
    
    .nav a {
      color: #2e7d32;
      text-decoration: none;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    
    .nav a:hover {
      background: rgba(232, 245, 233, 0.7);
    }
    
    .section {
      padding: 20px;
      background: rgba(255, 255, 255, 0.8);
      margin: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
      backdrop-filter: blur(2px);
      transition: all 0.3s ease;
    }
    
    .section:hover {
      background: rgba(255, 255, 255, 0.9);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .section-header h2 {
      color: #2e7d32;
    }
    
    .view-more {
      color: #2e7d32;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }
    
    ul { 
      list-style: none; 
      padding: 0; 
    }
    
    li { 
      background: rgba(249, 249, 249, 0.7); 
      margin: 10px 0; 
      padding: 15px; 
      border-radius: 8px; 
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s;
      cursor: pointer;
    }
    
    li:hover {
      background: rgba(249, 249, 249, 0.9);
    }
    
    .coin-info {
      display: flex;
      align-items: center;
    }
    
    img { 
      vertical-align: middle; 
      margin-right: 10px;
      width: 24px;
      height: 24px;
    }
    
    .price-change {
      font-weight: bold;
    }
    
    .positive {
      color: #2e7d32;
    }
    
    .negative {
      color: #c62828;
    }
    
    .crypto-table {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(224, 224, 224, 0.7);
      cursor: pointer;
    }
    
    th {
      color: #040504;
      font-weight: bold;
    }
    
    tr:hover {
      background: rgba(249, 249, 249, 0.7);
    }
    
    .gainers-trending {
      display: flex;
      justify-content: space-between;
      gap: 15px;
    }
    
    .gainers, .trending {
      flex: 1;
      background: rgba(249, 249, 249, 0.7);
      padding: 15px;
      border-radius: 6px;
      transition: background 0.3s;
    }
    
    .gainers:hover, .trending:hover {
      background: rgba(249, 249, 249, 0.9);
    }
    
    .gainers h3, .trending h3 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #2e7d32;
      margin-bottom: 15px;
    }
    
    .testimonials {
      text-align: center;
      padding: 30px 15px;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .testimonial-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      padding: 10px 20px;
    }
    
    .testimonial-box {
      background: rgba(249, 249, 249, 0.7);
      padding: 20px;
      flex: 1;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background 0.3s;
    }
    
    .testimonial-box:hover {
      background: rgba(249, 249, 249, 0.9);
    }
    
    .testimonial-box img {
      border-radius: 50%;
      width: 60px;
      height: 60px;
    }
    
    .stats-box {
      display: flex;
      justify-content: space-between;
      background: rgba(46, 125, 50, 0.8);
      color: white;
      padding: 20px;
      font-size: 18px;
      border-radius: 8px;
      margin: 15px;
    }
    
    .stats-box .number {
      color: #fff;
      font-size: 22px;
      font-weight: bold;
    }
    
    .withdrawals {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #a5aca5e6;
      color: #0c8a32;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-height: 120px;
      overflow-y: auto;
    }
    
    footer {
      text-align: center;
      background: rgba(3, 8, 3, 0.9);
      color: #fff;
      padding: 15px;
      font-size: 14px;
      margin-top: 20px;
      position: relative;
    }
    
    .live-chart {
      background: rgba(255, 255, 255, 0.8);
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      margin: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    iframe {
      width: 100%;
      height: 400px;
      border: none;
      border-radius: 8px;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .modal-content {
      background: rgba(255,255,255,0.95);
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 900px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .close-modal {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #2e7d32;
    }
    
    /* Coin detail styles */
    .coin-detail {
      margin-top: 20px;
    }
    
    .coin-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .coin-header img {
      width: 40px;
      height: 40px;
      margin-right: 15px;
    }
    
    .coin-name {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .coin-price {
      font-size: 28px;
      font-weight: bold;
      margin: 10px 0;
      color: #333;
    }
    
    .price-change {
      font-size: 18px;
      margin-bottom: 20px;
    }
    
    .coin-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      background: rgba(249, 249, 249, 0.7);
      padding: 15px;
      border-radius: 8px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .coin-chart {
      margin-top: 30px;
      height: 400px;
      background: rgba(249, 249, 249, 0.7);
      border-radius: 8px;
      padding: 20px;
    }
    
    .convert-btn {
      background: #2e7d32;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      margin-top: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .convert-btn:hover {
      background: #1b5e20;
    }
    
    /* Conversion modal styles */
    .conversion-form {
      margin-top: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .conversion-result {
      margin-top: 20px;
      padding: 15px;
      background: rgba(46, 125, 50, 0.1);
      border-radius: 4px;
      display: none;
    }
    
    /* Login and deposit prompts */
    .login-prompt {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 1001;
      text-align: center;
    }
    
    .login-prompt button {
      background: #2e7d32;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      margin-top: 15px;
      cursor: pointer;
    }
    
    .success-message {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 1001;
      text-align: center;
    }
    
    .user-balance {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(46, 125, 50, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .gainers-trending {
        flex-direction: column;
      }
      
      .testimonial-container {
        flex-direction: column;
      }
      
      .stats-box {
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
      
      .coin-stats {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }
  </style>
</head>
<body>
  <div class="background-container">
    <video autoplay muted loop playsinline>
      <source src="https://dl.dropboxusercontent.com/scl/fi/grduhrszolyx2ipyvjm64/Logo.mp4?rlkey=z9xijvc8x9cpjs7o2dq3r533b&st=iuyj95p2" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <header>
    <div class="logo-title">
      <video autoplay muted loop>
        <source src="https://dl.dropboxusercontent.com/scl/fi/grduhrszolyx2ipyvjm64/Logo.mp4?rlkey=z9xijvc8x9cpjs7o2dq3r533b&st=iuyj95p2" type="video/mp4">
      </video>
      <h1 onclick="window.location.href='index.html'">Crypto Trading Market</h1>
    </div>
    <div class="nav" id="navLinks">
      <a href="signup.html">Sign Up</a>
      <a href="login.html">Login</a>
    </div>
  </header>

  <div class="user-balance" id="userBalance"></div>

  <div class="section crypto-table">
    <div class="section-header">
      <h2>Live Crypto Data</h2>
      <a class="view-more" onclick="showMoreCoins()">View More</a>
    </div>
    <table id="cryptoTable">
      <thead>
        <tr>
          <th>Coin</th>
          <th>Price (USDT)</th>
          <th>1H %</th>
          <th>24H %</th>
          <th>7D %</th>
          <th>24H Volume</th>
          <th>Market Cap</th>
        </tr>
      </thead>
      <tbody id="mainCryptoTable">
        <!-- Top 7 coins will be loaded here by JavaScript -->
      </tbody>
    </table>
  </div>

  <div class="section gainers-trending">
    <div class="gainers">
      <h3>Top Gainers <a class="view-more" onclick="showMoreGainers()">View More</a></h3>
      <ul id="gainers">
        <!-- Gainers will be loaded here by JavaScript -->
      </ul>
    </div>
    <div class="trending">
      <h3>Trending Coins <a class="view-more" onclick="showMoreTrending()">View More</a></h3>
      <ul id="trending">
        <!-- Trending coins will be loaded here by JavaScript -->
      </ul>
    </div>
  </div>

  <div class="live-chart">
    <h2>BTC/USDT Live Market Chart</h2>
    <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_1&symbol=BINANCE:BTCUSDT&interval=1&hidesidetoolbar=1&theme=light"></iframe>
  </div>

  <div class="stats-box">
    <div>Total Registered Traders: <span class="number" id="traders">1,024,505</span></div>
    <div>Volume Traded: <span class="number" id="volume">$153.54B</span></div>
  </div>

  <div class="testimonials">
    <h2>What Other Traders Say</h2>
    <div class="testimonial-container">
      <div class="testimonial-box">
        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User">
        <p>This platform made trading straightforward, and I'm genuinely happy with how fast I've seen results.</p>
      </div>
      <div class="testimonial-box">
        <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User">
        <p>In just a few days, I made what used to take me a month. That feeling? Unmatched😊👌</p>
      </div>
      <div class="testimonial-box">
        <img src="https://randomuser.me/api/portraits/men/15.jpg" alt="User">
        <p>Funny how quickly things change when you stop relying only on a paycheck.</p>
      </div>
    </div>
  </div>

  <div class="withdrawals" id="withdrawals"></div>

  <footer>
    © 2025 Crypto Trading Market. All Rights Reserved
  </footer>

  <!-- Coin Detail Modal -->
  <div id="coinDetailModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('coinDetailModal')">&times;</span>
      <div id="coinDetailContent"></div>
    </div>
  </div>

  <!-- View More Modals -->
  <div id="moreCoinsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('moreCoinsModal')">&times;</span>
      <h2>All Cryptocurrencies</h2>
      <table id="allCoinsTable">
        <thead>
          <tr>
            <th>Coin</th>
            <th>Price (USDT)</th>
            <th>1H %</th>
            <th>24H %</th>
            <th>7D %</th>
            <th>24H Volume</th>
            <th>Market Cap</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="moreGainersModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('moreGainersModal')">&times;</span>
      <h2>All Top Gainers</h2>
      <ul id="allGainersList"></ul>
    </div>
  </div>

  <div id="moreTrendingModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('moreTrendingModal')">&times;</span>
      <h2>All Trending Coins</h2>
      <ul id="allTrendingList"></ul>
    </div>
  </div>

  <!-- Conversion Modal -->
  <div id="conversionModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('conversionModal')">&times;</span>
      <div id="conversionContent"></div>
    </div>
  </div>

  <!-- Login Prompt -->
  <div class="login-prompt" id="loginPrompt">
    <h3>Login Required</h3>
    <p>You need to login first to perform trading.</p>
    <button onclick="window.location.href='login.html'">Login Now</button>
  </div>

  <div class="success-message" id="successMessage">
    <h3>Trade Successful!</h3>
    <p id="successText">You've made a profit of $<span id="profitAmount">0</span> on this trade!</p>
    <button onclick="closeSuccess()">Continue Trading</button>
  </div>

  <script>
    // Function to format numbers with proper units
    function formatNumber(num) {
      if (num >= 1000000000000) {
        return '$' + (num / 1000000000000).toFixed(2) + 'T';
      } else if (num >= 1000000000) {
        return '$' + (num / 1000000000).toFixed(2) + 'B';
      } else if (num >= 1000000) {
        return '$' + (num / 1000000).toFixed(2) + 'M';
      } else if (num >= 1000) {
        return '$' + (num / 1000).toFixed(2) + 'K';
      }
      return '$' + num.toFixed(2);
    }

    // Function to format market cap
    function formatMarketCap(num) {
      if (num >= 1000000000000) {
        return '$' + (num / 1000000000000).toFixed(2) + 'T';
      } else if (num >= 1000000000) {
        return '$' + (num / 1000000000).toFixed(2) + 'B';
      }
      return '$' + num.toFixed(2);
    }

    // Function to format volume
    function formatVolume(num) {
      if (num >= 1000000000) {
        return '$' + (num / 1000000000).toFixed(2) + 'B';
      } else if (num >= 1000000) {
        return '$' + (num / 1000000).toFixed(2) + 'M';
      }
      return '$' + num.toFixed(2);
    }

    // User state
    let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
    let userBalance = parseFloat(localStorage.getItem('userBalance')) || 0;
    let allCoinsData = [];
    let allGainersData = [];
    let allTrendingData = [];
    let coinPrices = JSON.parse(localStorage.getItem('coinPrices')) || {};
    let withdrawalInterval;
    let withdrawalMessages = [];
    let statsInterval;
    let priceUpdateInterval;
    let currentConversionCoin = null;
    let initialCoins = []; // Track initial coins to exclude from "View More"

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user came from signup or login page
      const referrer = document.referrer;
      const fromSignupOrLogin = referrer.includes('signup.html') || referrer.includes('login.html');
      
      if (fromSignupOrLogin) {
        // Show the balance if user is logged in
        updateUserDisplay();
      }
      
      fetchLiveCryptoData();
      fetchTopGainers();
      fetchTrendingCoins();
      startWithdrawalCycle();
      startStatsIncrement();
      
      // Start price updates every 30 seconds
      priceUpdateInterval = setInterval(updatePrices, 30000);
      
      // Ensure video plays on mobile
      const videos = document.querySelectorAll('video');
      videos.forEach(video => {
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.play().catch(e => console.log('Video play prevented:', e));
      });
    });

    // Update prices with random variations within specified profit/loss ranges
    function updatePrices() {
      // Maximum loss: -5.33%, Maximum profit: +7.545%
      const maxLoss = -5.33;
      const maxProfit = 7.545;
      
      // Update prices for all coins with random variations
      for (const coinId in coinPrices) {
        if (coinPrices.hasOwnProperty(coinId)) {
          const originalPrice = coinPrices[coinId].originalPrice;
          
          // Determine if this update will be profit or loss (never both)
          const isProfit = Math.random() > 0.5; // 50% chance for profit or loss
          
          if (isProfit) {
            // Generate random profit between 0 and maxProfit
            const profitPercent = Math.random() * maxProfit;
            coinPrices[coinId].currentPrice = originalPrice * (1 + profitPercent/100);
            coinPrices[coinId].changePercent = profitPercent;
            coinPrices[coinId].isProfit = true;
          } else {
            // Generate random loss between maxLoss and 0
            const lossPercent = Math.random() * Math.abs(maxLoss);
            coinPrices[coinId].currentPrice = originalPrice * (1 - lossPercent/100);
            coinPrices[coinId].changePercent = -lossPercent;
            coinPrices[coinId].isProfit = false;
          }
        }
      }
      
      // Save updated prices
      localStorage.setItem('coinPrices', JSON.stringify(coinPrices));
      
      // Refresh displays
      updateCryptoTable();
      updateGainersList();
      updateTrendingList();
    }

    // Stats increment functionality
    function startStatsIncrement() {
      // Clear any existing interval
      if (statsInterval) {
        clearInterval(statsInterval);
      }
      
      // Start new interval (every 2 seconds)
      statsInterval = setInterval(incrementStats, 2000);
    }

    function incrementStats() {
      // Increment traders count by random number between 1 and 5
      const tradersElement = document.getElementById('traders');
      let tradersText = tradersElement.textContent.replace(/,/g, '');
      let tradersCount = parseInt(tradersText) || 1024505;
      tradersCount += Math.floor(Math.random() * 5) + 1;
      tradersElement.textContent = tradersCount.toLocaleString();
      
      // Increment volume traded by random amount between $1000 and $5000
      const volumeElement = document.getElementById('volume');
      let volumeText = volumeElement.textContent.replace(/[$,]/g, '');
      let volumeAmount = parseFloat(volumeText) || 153542364000;
      volumeAmount += Math.floor(Math.random() * 4000) + 1000;
      volumeElement.textContent = formatVolume(volumeAmount);
    }

    // User management functions
    function updateUserDisplay() {
      const userBalanceElement = document.getElementById('userBalance');
      const navLinks = document.getElementById('navLinks');
      
      if (currentUser) {
        navLinks.innerHTML = '<a href="javascript:void(0)" onclick="logoutUser()">Logout</a>';
        userBalanceElement.textContent = `Balance: $${userBalance.toFixed(2)}`;
        userBalanceElement.style.display = 'block';
        // Make balance clickable to go to dashboard
        userBalanceElement.onclick = function() {
          window.location.href = 'dashboard.html';
        };
      } else {
        navLinks.innerHTML = `
          <a href="signup.html">Sign Up</a>
          <a href="login.html">Login</a>
        `;
        userBalanceElement.style.display = 'none';
      }
    }

    function logoutUser() {
      currentUser = null;
      userBalance = 0;
      localStorage.removeItem('currentUser');
      localStorage.removeItem('userBalance');
      updateUserDisplay();
    }

    // Coin detail functionality
    function showCoinDetail(coin) {
      const modal = document.getElementById('coinDetailModal');
      const content = document.getElementById('coinDetailContent');
      
      // Get coin data
      const coinId = coin.id || coin.item?.id;
      const coinData = coinPrices[coinId] || {
        originalPrice: coin.current_price || coin.item?.data.price,
        currentPrice: coin.current_price || coin.item?.data.price,
        changePercent: 0,
        isProfit: true
      };
      
      // Format coin data
      const price = coinData.currentPrice;
      const priceChange24h = coin.price_change_percentage_24h || coin.item?.data.price_change_percentage_24h?.usd || 0;
      const marketCap = coin.market_cap || coin.item?.data.market_cap;
      const volume = coin.total_volume || coin.item?.data.total_volume;
      const high24h = coin.high_24h || coin.item?.data.high_24h?.usd;
      const low24h = coin.low_24h || coin.item?.data.low_24h?.usd;
      
      // Determine if showing profit or loss
      const isProfit = coinData.isProfit;
      const changePercent = coinData.changePercent;
      const changeAmount = (coinData.originalPrice * changePercent / 100).toFixed(2);
      
      content.innerHTML = `
        <div class="coin-detail">
          <div class="coin-header">
            <img src="${coin.image || coin.item?.small}" alt="${coin.name}" />
            <div class="coin-name">${coin.name}</div>
          </div>
          <div class="coin-price">$${price.toFixed(2)}</div>
          <div class="price-change ${isProfit ? 'positive' : 'negative'}">
            ${isProfit ? '+' : ''}${changePercent.toFixed(2)}% (${isProfit ? 'Profit' : 'Loss'})
          </div>
          
          <div class="coin-stats">
            <div class="stat-item">
              <div class="stat-label">Market Cap</div>
              <div class="stat-value">${formatMarketCap(marketCap)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">24h Trading Volume</div>
              <div class="stat-value">${formatVolume(volume)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">24h High</div>
              <div class="stat-value">$${high24h?.toFixed(2) || 'N/A'}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">24h Low</div>
              <div class="stat-value">$${low24h?.toFixed(2) || 'N/A'}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Current ${isProfit ? 'Profit' : 'Loss'}</div>
              <div class="stat-value ${isProfit ? 'positive' : 'negative'}">
                ${isProfit ? '+' : ''}${changePercent.toFixed(2)}% ($${changeAmount})
              </div>
            </div>
          </div>
          
          <div class="coin-chart">
            <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_coin_detail&symbol=BINANCE:${coin.symbol?.toUpperCase() || coin.id.toUpperCase()}USDT&interval=D&hidesidetoolbar=1&theme=light"></iframe>
          </div>
          
          <button class="convert-btn" onclick="showConversionForm('${coinId}')">Convert ${coin.name}</button>
        </div>
      `;
      
      modal.style.display = 'block';
    }

    // Show conversion form
    function showConversionForm(coinId) {
      if (!currentUser) {
        document.getElementById('loginPrompt').style.display = 'block';
        return;
      }
      
      currentConversionCoin = coinId;
      const coin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)].find(c => c.id === coinId);
      const coinPrice = coinPrices[coinId]?.currentPrice || (coin.current_price || coin.data.price);
      
      const modal = document.getElementById('conversionModal');
      const content = document.getElementById('conversionContent');
      
      // Get all available coins for the dropdown
      const allAvailableCoins = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)];
      const uniqueCoins = [];
      const seenIds = new Set();
      
      allAvailableCoins.forEach(c => {
        if (!seenIds.has(c.id) && c.id !== coinId) {
          seenIds.add(c.id);
          uniqueCoins.push(c);
        }
      });
      
      // Sort coins alphabetically
      uniqueCoins.sort((a, b) => a.name.localeCompare(b.name));
      
      // Generate options for the dropdown
      const options = uniqueCoins.map(c => 
        `<option value="${c.id}">${c.name} (${c.symbol?.toUpperCase() || c.id.toUpperCase()})</option>`
      ).join('');
      
      content.innerHTML = `
        <h2>Convert ${coin.name}</h2>
        <div class="conversion-form">
          <div class="form-row">
            <div class="form-group">
              <label>From</label>
              <input type="text" value="${coin.name} (${coin.symbol?.toUpperCase() || coin.id.toUpperCase()})" readonly>
            </div>
            <div class="form-group">
              <label>Amount</label>
              <input type="number" id="convertAmount" placeholder="Enter amount" min="0.00000001" step="0.00000001">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>To</label>
              <select id="convertToCoin">
                ${options}
              </select>
            </div>
            <div class="form-group">
              <label>Current Price</label>
              <input type="text" value="$${coinPrice.toFixed(2)}" readonly>
            </div>
          </div>
          
          <button class="convert-btn" onclick="calculateConversion()">Calculate Conversion</button>
          
          <div class="conversion-result" id="conversionResult">
            <h3>Conversion Result</h3>
            <p id="conversionText"></p>
            <button class="convert-btn" onclick="executeConversion()">Execute Trade</button>
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
    }

    // Calculate conversion
    function calculateConversion() {
      const amount = parseFloat(document.getElementById('convertAmount').value);
      const toCoinId = document.getElementById('convertToCoin').value;
      
      if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      const fromCoin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)].find(c => c.id === currentConversionCoin);
      const toCoin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)].find(c => c.id === toCoinId);
      
      if (!fromCoin || !toCoin) {
        alert('Error: Could not find coin data');
        return;
      }
      
      const fromPrice = coinPrices[currentConversionCoin]?.currentPrice || (fromCoin.current_price || fromCoin.data.price);
      const toPrice = coinPrices[toCoinId]?.currentPrice || (toCoin.current_price || toCoin.data.price);
      
      // Calculate conversion
      const convertedAmount = (amount * fromPrice) / toPrice;
      
      // Calculate profit/loss (based on the price difference)
      const isFromProfit = coinPrices[currentConversionCoin]?.isProfit || false;
      const isToProfit = coinPrices[toCoinId]?.isProfit || false;
      
      let profitText = '';
      if (isFromProfit && !isToProfit) {
        // Selling a coin that's at profit to buy one at loss - good trade
        const profitPercent = coinPrices[currentConversionCoin]?.changePercent || 0;
        const profitAmount = (amount * fromPrice * profitPercent / 100).toFixed(2);
        profitText = `This trade will realize a profit of $${profitAmount} (${profitPercent.toFixed(2)}%).`;
      } else if (!isFromProfit && isToProfit) {
        // Selling a coin at loss to buy one at profit - bad trade
        const lossPercent = Math.abs(coinPrices[currentConversionCoin]?.changePercent || 0);
        const lossAmount = (amount * fromPrice * lossPercent / 100).toFixed(2);
        profitText = `Warning: This trade will realize a loss of $${lossAmount} (${lossPercent.toFixed(2)}%).`;
      } else {
        profitText = `This is a neutral trade with no immediate profit or loss.`;
      }
      
      document.getElementById('conversionText').innerHTML = `
        <strong>${amount} ${fromCoin.symbol?.toUpperCase() || fromCoin.name}</strong> = 
        <strong>${convertedAmount.toFixed(8)} ${toCoin.symbol?.toUpperCase() || toCoin.name}</strong><br><br>
        ${profitText}
      `;
      
      document.getElementById('conversionResult').style.display = 'block';
    }

    // Execute the conversion
    function executeConversion() {
      const amount = parseFloat(document.getElementById('convertAmount').value);
      const toCoinId = document.getElementById('convertToCoin').value;
      
      if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      const fromCoin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)].find(c => c.id === currentConversionCoin);
      const toCoin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)].find(c => c.id === toCoinId);
      
      if (!fromCoin || !toCoin) {
        alert('Error: Could not find coin data');
        return;
      }
      
      const fromPrice = coinPrices[currentConversionCoin]?.currentPrice || (fromCoin.current_price || fromCoin.data.price);
      const toPrice = coinPrices[toCoinId]?.currentPrice || (toCoin.current_price || toCoin.data.price);
      
      // Calculate profit/loss
      const isFromProfit = coinPrices[currentConversionCoin]?.isProfit || false;
      let profitAmount = 0;
      
      if (isFromProfit) {
        const profitPercent = coinPrices[currentConversionCoin]?.changePercent || 0;
        profitAmount = amount * fromPrice * profitPercent / 100;
        userBalance += profitAmount;
        localStorage.setItem('userBalance', userBalance.toString());
        updateUserDisplay();
      }
      
      // Show success message
      document.getElementById('profitAmount').textContent = profitAmount.toFixed(2);
      document.getElementById('successText').innerHTML = isFromProfit ? 
        `You've made a profit of $${profitAmount.toFixed(2)} on this trade!` :
        `Trade executed successfully with no immediate profit or loss.`;
      
      document.getElementById('successMessage').style.display = 'block';
      closeModal('conversionModal');
    }

    function closeSuccess() {
      document.getElementById('successMessage').style.display = 'none';
    }

    // Fetch live crypto data with consistent pricing
    async function fetchLiveCryptoData() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=37&page=1&sparkline=false&price_change_percentage=1h,24h,7d');
        const data = await response.json();
        allCoinsData = data;
        
        // Track initial coins (first 7)
        initialCoins = data.slice(0, 7).map(coin => coin.id);
        
        // Initialize coin prices if not already set
        data.forEach(coin => {
          if (!coinPrices[coin.id]) {
            coinPrices[coin.id] = {
              originalPrice: coin.current_price,
              currentPrice: coin.current_price,
              changePercent: 0,
              isProfit: true
            };
          }
        });
        
        localStorage.setItem('coinPrices', JSON.stringify(coinPrices));
        
        // Update table with live data (only show first 7)
        updateCryptoTable();
      } catch (error) {
        console.error('Error fetching live crypto data:', error);
        // Fallback to static data if API fails
        const fallbackData = [
          {
            id: 'bitcoin',
            name: 'Bitcoin',
            symbol: 'btc',
            image: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579',
            current_price: 66300,
            price_change_percentage_1h_in_currency: 0.75,
            price_change_percentage_24h_in_currency: 2.35,
            price_change_percentage_7d_in_currency: 5.80,
            total_volume: 20154240000,
            market_cap: 950250000000
          },
          {
            id: 'ethereum',
            name: 'Ethereum',
            symbol: 'eth',
            image: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png?1595348880',
            current_price: 3025.50,
            price_change_percentage_1h_in_currency: 0.82,
            price_change_percentage_24h_in_currency: 3.25,
            price_change_percentage_7d_in_currency: 8.15,
            total_volume: 15254790000,
            market_cap: 350150000000
          },
          {
            id: 'ripple',
            name: 'XRP',
            symbol: 'xrp',
            image: 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png?1605778731',
            current_price: 0.52,
            price_change_percentage_1h_in_currency: 0.25,
            price_change_percentage_24h_in_currency: 1.55,
            price_change_percentage_7d_in_currency: 4.35,
            total_volume: 2154240000,
            market_cap: 25250000000
          },
          {
            id: 'cardano',
            name: 'Cardano',
            symbol: 'ada',
            image: 'https://assets.coingecko.com/coins/images/975/large/cardano.png?1547034860',
            current_price: 0.46,
            price_change_percentage_1h_in_currency: 0.35,
            price_change_percentage_24h_in_currency: 2.15,
            price_change_percentage_7d_in_currency: 6.85,
            total_volume: 854790000,
            market_cap: 15150000000
          },
          {
            id: 'binancecoin',
            name: 'Binance Coin',
            symbol: 'bnb',
            image: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png?1644979850',
            current_price: 580.25,
            price_change_percentage_1h_in_currency: 1.15,
            price_change_percentage_24h_in_currency: 4.55,
            price_change_percentage_7d_in_currency: 12.35,
            total_volume: 554240000,
            market_cap: 10250000000
          },
          {
            id: 'solana',
            name: 'Solana',
            symbol: 'sol',
            image: 'https://assets.coingecko.com/coins/images/4713/large/solana.png?1648133693',
            current_price: 142.75,
            price_change_percentage_1h_in_currency: 0.65,
            price_change_percentage_24h_in_currency: 3.25,
            price_change_percentage_7d_in_currency: 9.45,
            total_volume: 1254790000,
            market_cap: 18150000000
          },
          {
            id: 'tether',
            name: 'Tether',
            symbol: 'usdt',
            image: 'https://assets.coingecko.com/coins/images/325/large/Tether.png?1668148663',
            current_price: 1.00,
            price_change_percentage_1h_in_currency: 0.01,
            price_change_percentage_24h_in_currency: 0.02,
            price_change_percentage_7d_in_currency: 0.05,
            total_volume: 45254790000,
            market_cap: 83150000000
          }
        ];
        
        allCoinsData = fallbackData;
        initialCoins = fallbackData.map(coin => coin.id);
        
        // Initialize coin prices with fallback data
        fallbackData.forEach(coin => {
          if (!coinPrices[coin.id]) {
            coinPrices[coin.id] = {
              originalPrice: coin.current_price,
              currentPrice: coin.current_price,
              changePercent: 0,
              isProfit: true
            };
          }
        });
        
        localStorage.setItem('coinPrices', JSON.stringify(coinPrices));
        updateCryptoTable();
      }
    }

    // Update crypto table with current prices (only first 7 coins)
    function updateCryptoTable() {
      const tbody = document.querySelector("#mainCryptoTable");
      tbody.innerHTML = "";
      
      allCoinsData.slice(0, 7).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><img src="${coin.image}" alt="${coin.name}" width="20" style="vertical-align:middle;"> ${coin.name}</td>
          <td>$${coinData.currentPrice.toFixed(2)}</td>
          <td class="${coin.price_change_percentage_1h_in_currency >= 0 ? 'positive' : 'negative'}">${coin.price_change_percentage_1h_in_currency?.toFixed(2) || "0"}%</td>
          <td class="${coin.price_change_percentage_24h_in_currency >= 0 ? 'positive' : 'negative'}">${coin.price_change_percentage_24h_in_currency?.toFixed(2) || "0"}%</td>
          <td class="${coin.price_change_percentage_7d_in_currency >= 0 ? 'positive' : 'negative'}">${coin.price_change_percentage_7d_in_currency?.toFixed(2) || "0"}%</td>
          <td>${formatVolume(coin.total_volume)}</td>
          <td>${formatMarketCap(coin.market_cap)}</td>
        `;
        
        tr.addEventListener('click', () => showCoinDetail(coin));
        tbody.appendChild(tr);
      });
    }

    // Data fetching functions with consistent pricing
    async function fetchTopGainers(limit = 5) {
      try {
        const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=price_change_percentage_24h_desc&per_page=${limit}&page=1&sparkline=false&price_change_percentage=24h`);
        const data = await response.json();
        allGainersData = data;
        
        // Initialize coin prices for gainers if not already set
        data.forEach(coin => {
          if (!coinPrices[coin.id]) {
            coinPrices[coin.id] = {
              originalPrice: coin.current_price,
              currentPrice: coin.current_price,
              changePercent: 0,
              isProfit: true
            };
          }
        });
        
        localStorage.setItem('coinPrices', JSON.stringify(coinPrices));
        updateGainersList();
      } catch (error) {
        console.error('Error fetching top gainers:', error);
        const fallbackData = [
          {
            id: 'pepe',
            name: 'Pepe',
            symbol: 'pepe',
            image: 'https://assets.coingecko.com/coins/images/25783/large/pepe-token.jpeg?1696524471',
            current_price: 0.000012,
            price_change_percentage_24h: 24.56
          },
          {
            id: 'tether',
            name: 'Tether',
            symbol: 'usdt',
            image: 'https://assets.coingecko.com/coins/images/325/large/Tether.png?1668148663',
            current_price: 1.00,
            price_change_percentage_24h: 0.02
          },
          {
            id: 'solana',
            name: 'Solana',
            symbol: 'sol',
            image: 'https://assets.coingecko.com/coins/images/4713/large/solana.png?1648133693',
            current_price: 142.75,
            price_change_percentage_24h: 8.25
          },
          {
            id: 'ethereum',
            name: 'Ethereum',
            symbol: 'eth',
            image: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png?1595348880',
            current_price: 3025.50,
            price_change_percentage_24h: 5.75
          },
          {
            id: 'bitcoin',
            name: 'Bitcoin',
            symbol: 'btc',
            image: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579',
            current_price: 66300.00,
            price_change_percentage_24h: 3.45
          }
        ];
        
        allGainersData = fallbackData;
        
        // Initialize coin prices with fallback data
        fallbackData.forEach(coin => {
          if (!coinPrices[coin.id]) {
            coinPrices[coin.id] = {
              originalPrice: coin.current_price,
              currentPrice: coin.current_price,
              changePercent: 0,
              isProfit: true
            };
          }
        });
        
        localStorage.setItem('coinPrices', JSON.stringify(coinPrices));
        updateGainersList();
      }
    }

    // Update gainers list with current prices
    function updateGainersList() {
      const gainersList = document.getElementById("gainers");
      gainersList.innerHTML = '';
      
      allGainersData.slice(0, 5).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const change24h = coin.price_change_percentage_24h;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="coin-info">
            <img src="${coin.image}" alt="${coin.name}" />
            <span>${coin.name}</span>
          </div>
          <div class="price-change ${changeClass}">
            $${coinData.currentPrice.toFixed(2)} <span>${change24h.toFixed(2)}%</span>
          </div>
        `;
        
        li.addEventListener('click', () => showCoinDetail(coin));
        gainersList.appendChild(li);
      });
    }

    async function fetchTrendingCoins(limit = 5) {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/search/trending');
        const data = await response.json();
        allTrendingData = data.coins;
        
        // Initialize coin prices for trending coins if not already set
        data.coins.forEach(coin => {
          if (!coinPrices[coin.item.id]) {
            coinPrices[coin.item.id] = {
              originalPrice: coin.item.data.price,
              currentPrice: coin.item.data.price,
              changePercent: 0,
              isProfit: true
            };
          }
        });
        
        localStorage.setItem('coinPrices', JSON.stringify(coinPrices));
        updateTrendingList();
      } catch (error) {
        console.error('Error fetching trending coins:', error);
        const fallbackData = [
          {
            item: {
              id: 'bitcoin',
              name: 'Bitcoin',
              small: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579',
              data: {
                price: 66300.00,
                price_change_percentage_24h: { usd: 3.45 }
              }
            }
          },
          {
            item: {
              id: 'ethereum',
              name: 'Ethereum',
              small: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png?1595348880',
              data: {
                price: 3025.50,
                price_change_percentage_24h: { usd: 5.75 }
              }
            }
          },
          {
            item: {
              id: 'solana',
              name: 'Solana',
              small: 'https://assets.coingecko.com/coins/images/4713/large/solana.png?1648133693',
              data: {
                price: 142.75,
                price_change_percentage_24h: { usd: 8.25 }
              }
            }
          },
          {
            item: {
              id: 'binancecoin',
              name: 'Binance Coin',
              small: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png?1644979850',
              data: {
                price: 580.25,
                price_change_percentage_24h: { usd: 4.55 }
              }
            }
          },
          {
            item: {
              id: 'cardano',
              name: 'Cardano',
              small: 'https://assets.coingecko.com/coins/images/975/large/cardano.png?1547034860',
              data: {
                price: 0.46,
                price_change_percentage_24h: { usd: 2.15 }
              }
            }
          }
        ];
        
        allTrendingData = fallbackData;
        
        // Initialize coin prices with fallback data
        fallbackData.forEach(coin => {
          if (!coinPrices[coin.item.id]) {
            coinPrices[coin.item.id] = {
              originalPrice: coin.item.data.price,
              currentPrice: coin.item.data.price,
              changePercent: 0,
              isProfit: true
            };
          }
        });
        
        localStorage.setItem('coinPrices', JSON.stringify(coinPrices));
        updateTrendingList();
      }
    }

    // Update trending list with current prices
    function updateTrendingList() {
      const trendingList = document.getElementById("trending");
      trendingList.innerHTML = '';
      
      allTrendingData.slice(0, 5).forEach(coin => {
        const coinData = coinPrices[coin.item.id] || {
          currentPrice: coin.item.data.price,
          changePercent: 0,
          isProfit: true
        };
        
        const price = coinData.currentPrice;
        const change24h = coin.item.data.price_change_percentage_24h.usd;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="coin-info">
            <img src="${coin.item.small}" alt="${coin.item.name}" />
            <span>${coin.item.name}</span>
          </div>
          <div class="price-change ${changeClass}">
            $${price.toFixed(2)} <span>${change24h.toFixed(2)}%</span>
          </div>
        `;
        
        li.addEventListener('click', () => showCoinDetail(coin));
        trendingList.appendChild(li);
      });
    }

    // View More functions
    function showMoreCoins() {
      const modal = document.getElementById("moreCoinsModal");
      const tbody = document.querySelector("#allCoinsTable tbody");
      tbody.innerHTML = "";
      
      // Show coins 8-37 (excluding the first 7 initial coins)
      const additionalCoins = allCoinsData.slice(7, 37);
      
      additionalCoins.forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><img src="${coin.image}" alt="${coin.name}" width="20" style="vertical-align:middle;"> ${coin.name}</td>
          <td>$${coinData.currentPrice.toFixed(2)}</td>
          <td class="${coin.price_change_percentage_1h_in_currency >= 0 ? 'positive' : 'negative'}">${coin.price_change_percentage_1h_in_currency?.toFixed(2) || "0"}%</td>
          <td class="${coin.price_change_percentage_24h_in_currency >= 0 ? 'positive' : 'negative'}">${coin.price_change_percentage_24h_in_currency?.toFixed(2) || "0"}%</td>
          <td class="${coin.price_change_percentage_7d_in_currency >= 0 ? 'positive' : 'negative'}">${coin.price_change_percentage_7d_in_currency?.toFixed(2) || "0"}%</td>
          <td>${formatVolume(coin.total_volume)}</td>
          <td>${formatMarketCap(coin.market_cap)}</td>
        `;
        
        tr.addEventListener('click', () => {
          closeModal('moreCoinsModal');
          showCoinDetail(coin);
        });
        tbody.appendChild(tr);
      });
      
      modal.style.display = "block";
    }

    function showMoreGainers() {
      const modal = document.getElementById("moreGainersModal");
      const list = document.getElementById("allGainersList");
      list.innerHTML = "";
      
      allGainersData.forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const change24h = coin.price_change_percentage_24h;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="coin-info">
            <img src="${coin.image}" alt="${coin.name}" />
            <span>${coin.name}</span>
          </div>
          <div class="price-change ${changeClass}">
            $${coinData.currentPrice.toFixed(2)} <span>${change24h.toFixed(2)}%</span>
          </div>
        `;
        
        li.addEventListener('click', () => {
          closeModal('moreGainersModal');
          showCoinDetail(coin);
        });
        list.appendChild(li);
      });
      
      modal.style.display = "block";
    }

    function showMoreTrending() {
      const modal = document.getElementById("moreTrendingModal");
      const list = document.getElementById("allTrendingList");
      list.innerHTML = "";
      
      // Show trending coins that aren't in the initial 5
      const additionalTrending = allTrendingData.slice(5);
      
      additionalTrending.forEach(coin => {
        const coinData = coinPrices[coin.item.id] || {
          currentPrice: coin.item.data.price,
          changePercent: 0,
          isProfit: true
        };
        
        const price = coinData.currentPrice;
        const change24h = coin.item.data.price_change_percentage_24h.usd;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="coin-info">
            <img src="${coin.item.small}" alt="${coin.item.name}" />
            <span>${coin.item.name}</span>
          </div>
          <div class="price-change ${changeClass}">
            $${price.toFixed(2)} <span>${change24h.toFixed(2)}%</span>
          </div>
        `;
        
        li.addEventListener('click', () => {
          closeModal('moreTrendingModal');
          showCoinDetail(coin);
        });
        list.appendChild(li);
      });
      
      modal.style.display = "block";
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    // Withdrawal functionality
    function startWithdrawalCycle() {
      // Clear any existing interval
      if (withdrawalInterval) {
        clearInterval(withdrawalInterval);
      }
      
      // Start new interval (every 3 seconds)
      withdrawalInterval = setInterval(updateWithdrawalFeed, 3000);
      updateWithdrawalFeed();
    }

    function generateRandomWallet() {
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      let wallet = '';
      
      // Generate first 6 visible characters
      for (let i = 0; i < 6; i++) {
        wallet += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      // Add obscured middle part
      wallet += '**************************';
      
      // Generate last 6 visible characters
      for (let i = 0; i < 6; i++) {
        wallet += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      return wallet;
    }

    function updateWithdrawalFeed() {
      const coins = ['BTC', 'ETH', 'USDT', 'XRP', 'ADA', 'SOL', 'DOGE'];
      const coin = coins[Math.floor(Math.random() * coins.length)];
      
      let amount;
      if (coin === 'BTC') {
        amount = (0.00422 + Math.random() * 10.23).toFixed(6); // 0.00422 to 10.2343 BTC
      } else if (coin === 'ETH') {
        amount = (0.01 + Math.random() * 15).toFixed(4); // 0.01 to 15 ETH
      } else if (coin === 'USDT') {
        amount = (100 + Math.random() * 10000).toFixed(2); // 100 to 10100 USDT
      } else {
        amount = (10 + Math.random() * 1000).toFixed(2); // 10 to 1010 for other coins
      }
      
      const wallet = generateRandomWallet();
      const withdrawalText = `user ${wallet} withdrawn ${amount} ${coin}`;
      
      // Add to messages array and ensure no repeats
      if (!withdrawalMessages.includes(withdrawalText)) {
        withdrawalMessages.push(withdrawalText);
        if (withdrawalMessages.length > 10) {
          withdrawalMessages.shift();
        }
        
        // Update display
        document.getElementById('withdrawals').innerHTML = withdrawalMessages
          .map(msg => `<div>${msg}</div>`)
          .join('');
      }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.className === "modal") {
        event.target.style.display = "none";
      }
    }
  </script>
</body>
</html>